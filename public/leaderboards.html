<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>STATIFY: Leaderboards</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="/css/style.css" rel="stylesheet">
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-dark sticky-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="/"><i class="fas fa-chart-line"></i> STATIFY</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item">
                        <a class="nav-link" href="/">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/leaderboards">Leaderboards</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/matches">Matches</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/tickets">ðŸŽ« Tickets</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/add-player">Add Player</a>
                    </li>
                </ul>
                <a class="btn btn-warning btn-sm fw-bold" href="/login">Admin Login</a>
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <div style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); color: white; padding: 3rem 0; text-align: center;">
        <div class="container">
            <h1 style="font-size: 3rem; font-weight: 800; margin-bottom: 1rem;">
                <i class="fas fa-trophy"></i> Player Leaderboards
            </h1>
            <p style="font-size: 1.2rem; opacity: 0.9;">Explore comprehensive IPL player statistics across all categories</p>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container mt-5 mb-5">
        <!-- Filter Selection -->
        <div class="row mb-4">
            <div class="col-md-6 offset-md-3">
                <div class="card">
                    <div class="card-body">
                        <label for="statSelect" class="form-label fw-bold"><i class="fas fa-filter"></i> Select Statistic:</label>
                        <select id="statSelect" class="form-select" onchange="fetchAndDisplayLeaderboard()">
                            <option value="runs">Most Runs</option>
                            <option value="wickets">Most Wickets</option>
                            <option value="sixes">Most Sixes</option>
                            <option value="hundreds">Most Hundreds</option>
                            <option value="average">Best Average</option>
                            <option value="strike_rate">Best Strike Rate</option>
                            <option value="allrounders">ðŸŒŸ Top All-Rounders</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- Leaderboard Display -->
        <div class="row">
            <div class="col-lg-10 offset-lg-1">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0" id="leaderboardTitle"><i class="fas fa-chart-bar"></i> Most Runs</h5>
                    </div>
                    <div class="card-body p-0">
                        <div id="leaderboardContainer">
                            <div class="text-center p-5"><span class="spinner"></span></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer style="background: var(--primary-color); color: white; padding: 2rem 0; text-align: center;">
        <div class="container">
            <p style="margin: 0;">&copy; 2025 STATIFY - IPL Player Statistics Hub</p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_BASE = '/api';
        const statSelect = document.getElementById('statSelect');
        const leaderboardContainer = document.getElementById('leaderboardContainer');
        const leaderboardTitle = document.getElementById('leaderboardTitle');

        const statLabels = {
            'runs': { icon: 'fas fa-fire', label: 'Most Runs' },
            'wickets': { icon: 'fas fa-bowling-ball', label: 'Most Wickets' },
            'sixes': { icon: 'fas fa-star', label: 'Most Sixes' },
            'hundreds': { icon: 'fas fa-crown', label: 'Most Hundreds' },
            'average': { icon: 'fas fa-calculator', label: 'Best Average' },
            'strike_rate': { icon: 'fas fa-tachometer-alt', label: 'Best Strike Rate' },
            'allrounders': { icon: 'fas fa-star', label: 'ðŸŒŸ Top All-Rounders' }
        };

        function escapeHtml(str) {
            if (!str) return '';
            return str.replace(/&/g, "&amp;")
                       .replace(/</g, "&lt;")
                       .replace(/>/g, "&gt;")
                       .replace(/"/g, "&quot;")
                       .replace(/'/g, "&#039;");
        }

        function handleImageError(event) {
            event.target.onerror = null;
            event.target.src = 'https://placehold.co/60x60/1a1a2e/ffffff?text=Player';
        }

        async function fetchAndDisplayLeaderboard() {
            const stat = statSelect.value;
            const label = statLabels[stat];
            
            leaderboardTitle.innerHTML = `<i class="${label.icon}"></i> ${label.label}`;
            leaderboardContainer.innerHTML = '<div class="text-center p-5"><span class="spinner"></span></div>';

            try {
                const response = await fetch(`${API_BASE}/leaderboards/${stat}`);
                const players = await response.json();
                renderLeaderboard(players, stat);
            } catch (error) {
                console.error(`Error loading leaderboard:`, error);
                leaderboardContainer.innerHTML = '<p class="text-danger text-center p-5">Failed to load leaderboard</p>';
            }
        }

        function renderLeaderboard(players, stat) {
            if (players.length === 0) {
                leaderboardContainer.innerHTML = '<p class="text-center text-muted p-5">No players found</p>';
                return;
            }

            let html = '';
            players.forEach((player, index) => {
                // For all-rounders, use the allrounder_score field
                let statValue = stat === 'allrounders' ? player.allrounder_score : (player[stat] || 0);
                const displayValue = typeof statValue === 'number' && statValue % 1 !== 0 ? statValue.toFixed(2) : statValue;
                const medalEmoji = index === 0 ? 'ðŸ¥‡' : index === 1 ? 'ðŸ¥ˆ' : index === 2 ? 'ðŸ¥‰' : '';
                
                html += `
                    <div class="leaderboard-item" onclick="viewPlayerProfile('${escapeHtml(player.id)}')">
                        <div class="leaderboard-rank">
                            ${medalEmoji || '#' + (index + 1)}
                        </div>
                        <div class="leaderboard-player-info">
                            <img src="${escapeHtml(player.photo_url || '')}" alt="${escapeHtml(player.name)}" 
                                 class="player-photo" onerror="handleImageError(event)">
                            <div>
                                <div class="player-name">${escapeHtml(player.name)}</div>
                                <div class="player-team">${escapeHtml(player.team)}</div>
                            </div>
                        </div>
                        <div class="stat-value">${displayValue}</div>
                    </div>
                `;
            });

            leaderboardContainer.innerHTML = html;
        }

        function viewPlayerProfile(playerId) {
            window.location.href = `/player-profile?id=${encodeURIComponent(playerId)}`;
        }

        // Load default leaderboard on page load
        window.addEventListener('load', fetchAndDisplayLeaderboard);
    </script>
</body>
</html>
